import React, { useState, useEffect } from 'react';
import Auth from './Auth';
import { BrowserRouter as Router, Routes, Route, Link } from 'react-router-dom';
import { 
  AppBar, 
  Toolbar, 
  Typography, 
  Button, 
  Container, 
  Box, 
  CircularProgress,
  Alert,
  Card,
  CardContent,
  Grid
} from '@mui/material';
import { LibraryBooks, MenuBook, Home } from '@mui/icons-material';

// –ü—Ä–æ—Å—Ç—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
const HomePage: React.FC = () => {
  const [stats, setStats] = useState<any>(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    fetch('/api/libraries/stats/counts')
      .then(res => res.json())
      .then(data => {
        setStats(data);
        setLoading(false);
      })
      .catch(() => setLoading(false));
  }, []);

  return (
    <Container>
      <Box my={4}>
        <Typography variant="h3" gutterBottom>
          –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –ë–∏–±–ª–∏–æ—Ç–µ—á–Ω—É—é —Å–∏—Å—Ç–µ–º—É
        </Typography>
        <Typography variant="h6" color="textSecondary" paragraph>
          –£–ø—Ä–∞–≤–ª—è–π—Ç–µ –∫–Ω–∏–≥–∞–º–∏ –∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞–º–∏ –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ
        </Typography>
      </Box>

      {loading ? (
        <Box display="flex" justifyContent="center" my={4}>
          <CircularProgress />
        </Box>
      ) : stats ? (
        <Grid container spacing={3} my={4}>
          <Grid item xs={12} sm={4}>
            <Card>
              <CardContent>
                <Typography color="textSecondary" gutterBottom>
                  –ë–∏–±–ª–∏–æ—Ç–µ–∫
                </Typography>
                <Typography variant="h4">
                  {stats.totalLibraries}
                </Typography>
              </CardContent>
            </Card>
          </Grid>
          <Grid item xs={12} sm={4}>
            <Card>
              <CardContent>
                <Typography color="textSecondary" gutterBottom>
                  –í—Å–µ–≥–æ –∫–Ω–∏–≥
                </Typography>
                <Typography variant="h4">
                  {stats.totalBooks}
                </Typography>
              </CardContent>
            </Card>
          </Grid>
          <Grid item xs={12} sm={4}>
            <Card>
              <CardContent>
                <Typography color="textSecondary" gutterBottom>
                  –î–æ—Å—Ç—É–ø–Ω–æ –∫–Ω–∏–≥
                </Typography>
                <Typography variant="h4">
                  {stats.totalAvailableBooks}
                </Typography>
              </CardContent>
            </Card>
          </Grid>
        </Grid>
      ) : (
        <Alert severity="warning">
          –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ API.
        </Alert>
      )}
    </Container>
  );
};

const LibrariesPage: React.FC = () => {
  const [libraries, setLibraries] = useState<any[]>([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    fetch('/api/libraries')
      .then(res => res.json())
      .then(data => {
        setLibraries(data);
        setLoading(false);
      })
      .catch(() => setLoading(false));
  }, []);

  return (
    <Container>
      <Box my={4}>
        <Typography variant="h4" gutterBottom>
          –ë–∏–±–ª–∏–æ—Ç–µ–∫–∏
        </Typography>
      </Box>

      {loading ? (
        <Box display="flex" justifyContent="center">
          <CircularProgress />
        </Box>
      ) : libraries.length === 0 ? (
        <Alert severity="info">–ë–∏–±–ª–∏–æ—Ç–µ–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</Alert>
      ) : (
        <Grid container spacing={3}>
          {libraries.map(lib => (
            <Grid item xs={12} sm={6} md={4} key={lib.id}>
              <Card>
                <CardContent>
                  <Typography variant="h6" gutterBottom>
                    {lib.name}
                  </Typography>
                  <Typography color="textSecondary" gutterBottom>
                    {lib.address}
                  </Typography>
                  <Typography variant="body2" paragraph>
                    {lib.description}
                  </Typography>
                  <Typography variant="body2" color="primary">
                    –ö–Ω–∏–≥: {lib.books?.length || 0}
                  </Typography>
                </CardContent>
              </Card>
            </Grid>
          ))}
        </Grid>
      )}
    </Container>
  );
};

const BooksPage: React.FC = () => {
  const [books, setBooks] = useState<any[]>([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    fetch('/api/libraries/books/new')
      .then(res => res.json())
      .then(data => {
        setBooks(data);
        setLoading(false);
      })
      .catch(() => setLoading(false));
  }, []);

  return (
    <Container>
      <Box my={4}>
        <Typography variant="h4" gutterBottom>
          –ö–Ω–∏–≥–∏
        </Typography>
      </Box>

      {loading ? (
        <Box display="flex" justifyContent="center">
          <CircularProgress />
        </Box>
      ) : books.length === 0 ? (
        <Alert severity="info">–ö–Ω–∏–≥–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</Alert>
      ) : (
        <Grid container spacing={3}>
          {books.map(book => (
            <Grid item xs={12} sm={6} md={4} key={book.id}>
              <Card>
                <CardContent>
                  <Typography variant="h6" gutterBottom>
                    {book.title}
                  </Typography>
                  <Typography color="textSecondary" gutterBottom>
                    {book.author} ({book.year})
                  </Typography>
                  <Typography variant="body2" paragraph>
                    {book.description?.substring(0, 100)}...
                  </Typography>
                  <Box display="flex" justifyContent="space-between">
                    <Typography variant="body2" color="primary">
                      {book.library.name}
                    </Typography>
                    <Typography variant="body2" color="textSecondary">
                      {book.availableCopies}/{book.totalCopies}
                    </Typography>
                  </Box>
                </CardContent>
              </Card>
            </Grid>
          ))}
        </Grid>
      )}
    </Container>
  );
};

const Navigation: React.FC = () => {
  return (
    <AppBar position="static">
      <Container>
        <Toolbar>
          <LibraryBooks sx={{ mr: 2 }} />
          <Typography variant="h6" component={Link} to="/" sx={{ flexGrow: 1, textDecoration: 'none', color: 'inherit' }}>
            –ë–∏–±–ª–∏–æ—Ç–µ—á–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞
          </Typography>
          <Button color="inherit" component={Link} to="/" startIcon={<Home />}>
            –ì–ª–∞–≤–Ω–∞—è
          </Button>
          <Button color="inherit" component={Link} to="/libraries" startIcon={<LibraryBooks />}>
            –ë–∏–±–ª–∏–æ—Ç–µ–∫–∏
          </Button>
          <Button color="inherit" component={Link} to="/books" startIcon={<MenuBook />}>
            –ö–Ω–∏–≥–∏
          </Button>
        </Toolbar>
      </Container>
    </AppBar>
  );
};

const App: React.FC = () => {
  return (
    <div style={{ padding: '20px', maxWidth: '1200px', margin: '0 auto' }}>
      <header style={{ textAlign: 'center', marginBottom: '40px' }}>
        <h1 style={{ color: '#1976d2' }}>Ì≥ö –ë–∏–±–ª–∏–æ—Ç–µ—á–Ω—ã–π –ê–≥—Ä–µ–≥–∞—Ç–æ—Ä</h1>
        <p>–ü–æ–∏—Å–∫ –∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–Ω–∏–≥ –≤ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞—Ö –≥–æ—Ä–æ–¥–∞</p>
      </header>

      <div style={{ display: 'grid', gridTemplateColumns: '1fr 2fr', gap: '30px' }}>
        {/* –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ - –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è */}
        <div>
          <Auth />
        </div>

        {/* –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ - –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç */}
        <div>
          <h2>–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª —Å–∏—Å—Ç–µ–º—ã</h2>
          
          <div style={{ marginBottom: '30px' }}>
            <h3>Ìπ∫ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è API</h3>
            <button 
              onClick={async () => {
                try {
                  const response = await fetch('/api/health');
                  const data = await response.json();
                  alert(`–°—Ç–∞—Ç—É—Å: ${data.status}\n–í—Ä–µ–º—è: ${new Date(data.timestamp).toLocaleTimeString()}`);
                } catch (error) {
                  alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ API');
                }
              }}
              style={{ padding: '10px 20px', backgroundColor: '#28a745', color: 'white', border: 'none', borderRadius: '4px', cursor: 'pointer' }}
            >
              –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Health
            </button>
          </div>

          <div style={{ marginBottom: '30px' }}>
            <h3>Ì≥ñ –°–ø–∏—Å–æ–∫ –±–∏–±–ª–∏–æ—Ç–µ–∫</h3>
            <button 
              onClick={async () => {
                try {
                  const response = await fetch('/api/libraries');
                  const data = await response.json();
                  alert(`–ù–∞–π–¥–µ–Ω–æ –±–∏–±–ª–∏–æ—Ç–µ–∫: ${data.length}\n–ü–µ—Ä–≤–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞: ${data[0]?.name}`);
                } catch (error) {
                  alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫');
                }
              }}
              style={{ padding: '10px 20px', backgroundColor: '#17a2b8', color: 'white', border: 'none', borderRadius: '4px', cursor: 'pointer' }}
            >
              –ü–æ–ª—É—á–∏—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
            </button>
          </div>

          <div style={{ marginBottom: '30px' }}>
            <h3>Ì¥ç –ü–æ–∏—Å–∫ –∫–Ω–∏–≥</h3>
            <div style={{ display: 'flex', gap: '10px' }}>
              <input
                type="text"
                placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–Ω–∏–≥–∏"
                style={{ padding: '10px', flex: 1, border: '1px solid #ddd', borderRadius: '4px' }}
              />
              <button 
                style={{ padding: '10px 20px', backgroundColor: '#ffc107', color: '#212529', border: 'none', borderRadius: '4px', cursor: 'pointer' }}
              >
                –ù–∞–π—Ç–∏ –∫–Ω–∏–≥–∏
              </button>
            </div>
          </div>

          <div style={{ marginBottom: '30px' }}>
            <h3>Ìª°Ô∏è –ó–∞—â–∏—â–µ–Ω–Ω—ã–π –º–∞—Ä—à—Ä—É—Ç</h3>
            <button 
              onClick={async () => {
                const token = localStorage.getItem('token');
                if (!token) {
                  alert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É!');
                  return;
                }

                try {
                  const response = await fetch('/api/protected', {
                    headers: { 'Authorization': `Bearer ${token}` }
                  });
                  const data = await response.json();
                  alert(data.message);
                } catch (error) {
                  alert('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∑–∞—â–∏—â–µ–Ω–Ω–æ–º—É –º–∞—Ä—à—Ä—É—Ç—É');
                }
              }}
              style={{ padding: '10px 20px', backgroundColor: '#6f42c1', color: 'white', border: 'none', borderRadius: '4px', cursor: 'pointer' }}
            >
              –î–æ—Å—Ç—É–ø –∫ –∑–∞—â–∏—â–µ–Ω–Ω—ã–º –¥–∞–Ω–Ω—ã–º
            </button>
          </div>
        </div>
      </div>

      <footer style={{ marginTop: '50px', textAlign: 'center', color: '#666', borderTop: '1px solid #eee', paddingTop: '20px' }}>
        <p>¬© 2024 –ë–∏–±–ª–∏–æ—Ç–µ—á–Ω—ã–π –ê–≥—Ä–µ–≥–∞—Ç–æ—Ä. –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã.</p>
      </footer>
    </div>
  );
};

export default App;
