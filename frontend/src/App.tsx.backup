import React, { useState, useEffect } from 'react';
import './App.css';

interface Book {
  id: number;
  title: string;
  author: string;
  year: number;
  description: string;
  totalCopies: number;
  availableCopies: number;
  library: {
    id: number;
    name: string;
    address: string;
  };
}

interface Library {
  id: number;
  name: string;
  address: string;
  description: string;
  books: Book[];
}

interface Stats {
  totalLibraries: number;
  totalBooks: number;
  totalAvailableBooks: number;
}

function App() {
  const [stats, setStats] = useState<Stats | null>(null);
  const [books, setBooks] = useState<Book[]>([]);
  const [libraries, setLibraries] = useState<Library[]>([]);
  const [loading, setLoading] = useState(true);
  const [activeTab, setActiveTab] = useState<'stats' | 'books' | 'libraries'>('stats');

  useEffect(() => {
    fetchData();
  }, []);

  const fetchData = async () => {
    try {
      setLoading(true);
      const [statsRes, booksRes, libsRes] = await Promise.all([
        fetch('/api/libraries/stats/counts'),
        fetch('/api/libraries/books/new'),
        fetch('/api/libraries')
      ]);
      
      const statsData = await statsRes.json();
      const booksData = await booksRes.json();
      const libsData = await libsRes.json();
      
      setStats(statsData);
      setBooks(booksData);
      setLibraries(libsData);
    } catch (error) {
      console.error('Error fetching data:', error);
    } finally {
      setLoading(false);
    }
  };

  if (loading) {
    return (
      <div className="loading">
        <div className="spinner"></div>
        <p>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p>
      </div>
    );
  }

  return (
    <div className="App">
      <header className="header">
        <h1>Ì≥ö –ë–∏–±–ª–∏–æ—Ç–µ—á–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞</h1>
        <p>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞–º–∏ –∏ –∫–Ω–∏–≥–∞–º–∏</p>
      </header>

      <nav className="tabs">
        <button 
          className={activeTab === 'stats' ? 'active' : ''}
          onClick={() => setActiveTab('stats')}
        >
          Ì≥ä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        </button>
        <button 
          className={activeTab === 'books' ? 'active' : ''}
          onClick={() => setActiveTab('books')}
        >
          Ì≥ñ –ö–Ω–∏–≥–∏ ({books.length})
        </button>
        <button 
          className={activeTab === 'libraries' ? 'active' : ''}
          onClick={() => setActiveTab('libraries')}
        >
          ÌøõÔ∏è –ë–∏–±–ª–∏–æ—Ç–µ–∫–∏ ({libraries.length})
        </button>
      </nav>

      <main className="main-content">
        {activeTab === 'stats' && stats && (
          <div className="stats-grid">
            <div className="stat-card">
              <h3>ÌøõÔ∏è –ë–∏–±–ª–∏–æ—Ç–µ–∫</h3>
              <p className="stat-number">{stats.totalLibraries}</p>
            </div>
            <div className="stat-card">
              <h3>Ì≥ö –í—Å–µ–≥–æ –∫–Ω–∏–≥</h3>
              <p className="stat-number">{stats.totalBooks}</p>
            </div>
            <div className="stat-card">
              <h3>‚úÖ –î–æ—Å—Ç—É–ø–Ω–æ –∫–Ω–∏–≥</h3>
              <p className="stat-number">{stats.totalAvailableBooks}</p>
            </div>
          </div>
        )}

        {activeTab === 'books' && (
          <div className="books-grid">
            {books.map(book => (
              <div key={book.id} className="book-card">
                <h3>{book.title}</h3>
                <p className="author">Ì±§ {book.author}</p>
                <p className="year">Ì≥Ö {book.year} –≥–æ–¥</p>
                <p className="library">ÌøõÔ∏è {book.library.name}</p>
                <p className="description">{book.description}</p>
                <div className="copies">
                  <span>Ì≥ö –í—Å–µ–≥–æ: {book.totalCopies}</span>
                  <span>‚úÖ –î–æ—Å—Ç—É–ø–Ω–æ: {book.availableCopies}</span>
                </div>
              </div>
            ))}
          </div>
        )}

        {activeTab === 'libraries' && (
          <div className="libraries-list">
            {libraries.map(library => (
              <div key={library.id} className="library-card">
                <h3>{library.name}</h3>
                <p className="address">ÔøΩÔøΩ {library.address}</p>
                <p className="description">{library.description}</p>
                <div className="books-count">
                  <span>Ì≥ö –ö–Ω–∏–≥ –≤ –±–∏–±–ª–∏–æ—Ç–µ–∫–µ: {library.books?.length || 0}</span>
                </div>
                {library.books && library.books.length > 0 && (
                  <div className="library-books">
                    <h4>–ö–Ω–∏–≥–∏ –≤ —ç—Ç–æ–π –±–∏–±–ª–∏–æ—Ç–µ–∫–µ:</h4>
                    <ul>
                      {library.books.slice(0, 3).map(book => (
                        <li key={book.id}>{book.title} - {book.author}</li>
                      ))}
                      {library.books.length > 3 && (
                        <li>... –∏ –µ—â—ë {library.books.length - 3} –∫–Ω–∏–≥</li>
                      )}
                    </ul>
                  </div>
                )}
              </div>
            ))}
          </div>
        )}
      </main>

      <footer className="footer">
        <p>API —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –ø–æ—Ä—Ç—É 3000 | –í—Å–µ–≥–æ –∫–Ω–∏–≥ –≤ —Å–∏—Å—Ç–µ–º–µ: {stats?.totalBooks}</p>
        <button className="refresh-btn" onClick={fetchData}>
          Ì¥Ñ –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
        </button>
      </footer>
    </div>
  );
}

export default App;
